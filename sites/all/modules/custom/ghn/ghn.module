<?php
/**
 * Form alter 
 **/
function ghn_form_alter(&$form,&$form_state,$form_id) {
         $tmp = $form_id;
 //drupal_set_message(" IN GHN FORM ALTER ".$tmp);
//krumo($form);
//krumo($form_id);
         switch($form_id) {
         case "profile2_edit_main_form":
            //$tmp = var_export($form['und'][0]['registration_type'],TRUE);
            $tmp = var_export($form['profile_main']['field_choose_membership_type']['und'][0]['registration_type']['#options'],TRUE);
            unset($form['profile_main']['field_choose_membership_type']['und'][0]['registration_type']['#options']['']);
            $form['profile_main']['field_choose_membership_type']['und'][0]['registration_type']['#title'] = "Memberhsip Type";
            break;
         case "user_register_form":
            $tmp = var_export($form,TRUE);
            break;
         case "user_login_block":
            $form['#submit'][] = 'ghn_user_login_submit';
            break;
         default:
            break;
         }
/*
$tmp = var_export($form['links']['#markup'],TRUE);
print '<pre>';
print $tmp;
print '</pre>';
*/
}
/**
 * hook_menu
 **/
function ghn_menu() {
    $items['main-profile'] = array(
        'page callback' => '_profile2_main_form',
        'page arguments' => array(),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    $items['general-profile'] = array(
        'page callback' => '_profile2_general_form',
        'page arguments' => array(),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    $items['detail-profile'] = array(
        'page callback' => '_profile2_detail_form',
        'page arguments' => array(),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    return $items;
}
/**
 * profile2 is not registering profile pages with the menu
 * this is the hack for it, so page existing manager can find it 
 * for panels consumption
 **/
function _profile2_main_form() {
    global $user;
    module_load_include('inc', 'profile2_page', 'profile2_page');
    $profile2 = profile2_by_uid_load($user->uid, 'main');
    $entity_form = entity_ui_get_form('profile2', $profile2, 'edit');
    return $entity_form;    
}
function _profile2_general_form() {
    global $user;
    module_load_include('inc', 'profile2_page', 'profile2_page');
    $profile2 = profile2_by_uid_load($user->uid, 'general');
    $entity_form = entity_ui_get_form('profile2', $profile2, 'edit');
    return $entity_form;    
}
function _profile2_detail_form() {
    global $user;
    $uid = $user->uid;
    module_load_include('inc', 'profile2_page', 'profile2_page');
    $results = db_query("SELECT field_choose_membership_type_registration_type AS memtype FROM {field_data_field_choose_membership_type} m LEFT JOIN {profile} p ON m.entity_id = p.pid WHERE p.uid = :uid",array(':uid'=>$uid));
    foreach ($results as $result) {
            $mtype = $result->memtype;
    }
    switch ($mtype) {
           case "individual": // individual role
                $profile2 = profile2_by_uid_load($user->uid, 'individual');
                $entity_form = entity_ui_get_form('profile2', $profile2, 'edit');
                break;
           case "hospital":
                $profile2 = profile2_by_uid_load($user->uid, 'hospital');
                $entity_form = entity_ui_get_form('profile2', $profile2, 'edit');
                break;
           case "organization":
                $profile2 = profile2_by_uid_load($user->uid, 'organization');
                $entity_form = entity_ui_get_form('profile2', $profile2, 'edit');
                break;
           case "government":
                $profile2 = profile2_by_uid_load($user->uid, 'government');
                $entity_form = entity_ui_get_form('profile2', $profile2, 'edit');
                break;
           default:
                $entity_form = "No Detail Profile";
                break;
                
    }
    return $entity_form;    
}
/**
 * This is called from page--front.tpl.php
 * to render user register form
 **/
function ghn_user_register() {
     $ret = drupal_get_form("user_register_form");
     return drupal_render($ret);
}


